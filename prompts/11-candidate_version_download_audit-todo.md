# TODO List

Consider the following rules during execution of the tasks:
- rules/git-rules.md
- kotlin-rules.md
- kotest-rules.md

## Task 1: Rename Data Classes for Better Semantics

- [X] Rename data classes to more descriptive names

**Prompt**: Rename the `DownloadResponse` data class to `DownloadInfo` and the `AuditRequest` data class to `AuditCommand` in the `VersionService.kt` file. These renames will better reflect the actual purpose of these classes. Make sure to update all references to these classes throughout the codebase.

**Files affected**:
- `src/main/kotlin/io/sdkman/broker/application/service/VersionService.kt`

## Task 2: Extract Actual Distribution Logic

- [X] Extract the actual distribution inference to a well-named method on Version

**Prompt**: Extract the actual distribution inference logic in the `VersionService.kt` file (line 73) into a well-named method on the `Version` class. This logic currently infers actual distribution inline and should be moved to improve code organization and readability.

**Files affected**:
- `src/main/kotlin/io/sdkman/broker/application/service/VersionService.kt`

## Task 3: Move Audit Conversion Logic to Data Class

- [X] Move audit conversion logic to AuditRequest/AuditCommand

**Prompt**: Move the audit conversion logic (line 116) from `VersionService.kt` to the `AuditRequest` or `AuditCommand` class as a `toAudit()` method. This will improve encapsulation and make the conversion logic reusable.

**Files affected**:
- `src/main/kotlin/io/sdkman/broker/application/service/VersionService.kt`

## Task 4: Add Mock Verifications to Unit Tests

- [ ] Add appropriate mock verifications to VersionServiceSpec

**Prompt**: Add appropriate mock verifications on the `mockAuditRepository` for each test scenario in `VersionServiceSpec.kt`. This will ensure that the repository methods are being called correctly with the expected parameters.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/application/service/VersionServiceSpec.kt`

## Task 5: Remove Deprecated PostgresTestSupport Method

- [X] Remove deprecated readSavedAuditRecord method

**Prompt**: Remove the deprecated `readSavedAuditRecord` method from `PostgresTestSupport.kt` (line 22) and update any remaining callsites to use `readSavedAuditRecordByVersion` instead. Also enhance the `readSavedAuditRecordByVersion` method to include optional `vendor` parameter as noted in the TODO comment.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/support/PostgresTestSupport.kt`

## Task 6: Add Missing Test Cases for Audit Repository

- [X] Add test cases for null host and user agent

**Prompt**: Add test cases in `PostgresAuditRepositoryIntegrationSpec.kt` for successfully saving audit records with null host (line 93) and null user agent (line 95). Also replace the generic `readSavedAuditRecord` call with a more targeted method that specifies version (line 116), and simplify assertions to only check autogenerated ID where appropriate (line 126).

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/adapter/secondary/persistence/PostgresAuditRepositoryIntegrationSpec.kt`

## Task 7: Introduce DownloadResponse Class

- [X] Create DownloadResponse class for REST responses

**Prompt**: Introduce a new `DownloadResponse` class in the rest package to properly encapsulate download response data instead of using generic data structures in `DownloadRoutes.kt` (line 29).

**Files affected**:
- `src/main/kotlin/io/sdkman/broker/adapter/primary/rest/DownloadRoutes.kt`

## Task 8: Add Acceptance Test Tags

- [X] Add "acceptance" tags to test classes

**Prompt**: Add "acceptance" test tags to the following test classes: `VersionDownloadAcceptanceSpec.kt`, `VersionDownloadAuditAcceptanceSpec.kt`, `HealthCheckAcceptanceSpec.kt`, and `ReleaseEndpointAcceptanceSpec.kt`. This will help categorize tests properly for test execution strategies.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/acceptance/VersionDownloadAcceptanceSpec.kt`
- `src/test/kotlin/io/sdkman/broker/acceptance/VersionDownloadAuditAcceptanceSpec.kt`
- `src/test/kotlin/io/sdkman/broker/acceptance/HealthCheckAcceptanceSpec.kt`
- `src/test/kotlin/io/sdkman/broker/acceptance/ReleaseEndpointAcceptanceSpec.kt`

## Task 9: Replace Thread Sleeps with Await Retry Strategy

- [ ] Replace Thread.sleep with proper await retry strategy

**Prompt**: Replace all `Thread.sleep` calls in `VersionDownloadAuditAcceptanceSpec.kt` (lines 65, 128, 190) with proper await retry strategies. Thread sleeps make tests flaky and slow. Implement a robust retry mechanism that waits for the expected condition to be met.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/acceptance/VersionDownloadAuditAcceptanceSpec.kt`

## Task 10: Use shouldBeSomeAnd Helper for Assertions

- [ ] Create and use shouldBeSomeAnd helper for Option assertions

**Prompt**: Create a `shouldBeSomeAnd` helper method for Arrow Option assertions and use it to replace the verbose assertion patterns in `VersionDownloadAuditAcceptanceSpec.kt` (lines 76, 139, 201). This will make the test assertions more readable and concise.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/acceptance/VersionDownloadAuditAcceptanceSpec.kt`

## Task 11: Use shouldBeNone Helper for Option Assertions

- [ ] Create and use shouldBeNone helper for None assertions

**Prompt**: Create a `shouldBeNone` helper method for Arrow Option assertions if it doesn't exist, and use it to replace verbose None assertion patterns in `VersionDownloadAuditAcceptanceSpec.kt` (lines 306, 339). This will improve test readability.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/acceptance/VersionDownloadAuditAcceptanceSpec.kt`

## Task 12: Use Ktor UserAgent Plugin for Header Management

- [ ] Use Ktor UserAgent plugin to manage User-Agent headers

**Prompt**: Use the Ktor UserAgent plugin to properly remove or manage User-Agent headers in tests in `VersionDownloadAuditAcceptanceSpec.kt` (lines 180, 211) instead of manual header manipulation. This will provide better control over HTTP headers in tests.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/acceptance/VersionDownloadAuditAcceptanceSpec.kt`

## Task 13: Remove Pointless Test

- [ ] Remove the pointless test method

**Prompt**: Remove the pointless test method identified in `VersionDownloadAuditAcceptanceSpec.kt` (line 220). This test doesn't add value and should be eliminated to keep the test suite clean.

**Files affected**:
- `src/test/kotlin/io/sdkman/broker/acceptance/VersionDownloadAuditAcceptanceSpec.kt`

## Execution plan workflow

The following workflow applies when executing this TODO list:
- Execute the next uncompleted task
- Implement the task in **THE SIMPLEST WAY POSSIBLE**
- Run the tests, format and perform static analysis on the code:
    - ./gradlew ktlintFormat
    - ./gradlew test
    - ./gradlew detekt
- **Ask me to review the task once you have completed and then WAIT FOR ME**
- Mark the TODO item as complete with [X]
- Commit the change and TODO list to Git when I've approved and/or amended the code
- Stop execution
