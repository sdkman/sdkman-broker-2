# SDKMAN Broker Service – Login Specification

## Overview

The SDKMAN Broker service is responsible for resolving and redirecting download requests for SDK binaries (both SDKMAN’s own CLI and third-party SDKs) via a unified HTTP API. It also handles audit logging for these download events. The service is implemented in Kotlin using Ratpack and interacts with a MongoDB persistence layer for metadata (candidates, versions, and current CLI version info).

## HTTP Endpoints

### GET `/download/{candidate}/{version}/{platform}`

Handles redirecting to the binary URL for a given SDK **candidate**, **version**, and **platform**. This is the primary endpoint for all SDK downloads (including SDKMAN’s CLI when treated as a candidate). The logic proceeds as follows:

- **Input Parsing & Validation:** The path variables are parsed into `candidate`, `version`, and `platform`. The `candidate` string is expected in lowercase (as stored in the DB). The `platform` is expected as a known code (e.g. `linuxx64`, `linuxarm64`, `darwinx64`, `darwinarm64`, `windowsx64`, etc.) or the special code `exotic`. If the provided platform code is not recognized as one of the supported keys (including `exotic`), the request is considered invalid. In this case, the broker returns **HTTP 400 Bad Request** (with no redirect) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=When%20a%20download%20request%20is,download%2Fjava%2F8u101%2Ffoobar)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=%6050%60%60%60%60)). No audit entry is recorded on a 400.

- **Candidate Existence:** The broker checks if the `candidate` exists in the persistence store. If the candidate is not found at all, it returns **HTTP 404 Not Found** ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=When%20a%20download%20request%20is,download%2Fgroovy%2Flinuxx64)). (This is treated as a missing resource – an “invalid candidate” – rather than a bad request.) No audit entry is recorded for 404 in this case ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=Then%20the%20service%20response%20status,is%20404)).

- **Version Existence:** If the candidate exists, the broker looks up the specified `version` for that candidate. If the version is not found (no record of that version for the candidate), the broker returns **HTTP 404 Not Found** ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=%6053%60%60%60%60)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)). No audit entry is recorded when the version is invalid or not present ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)).

- **Platform Resolution & Fallback:** If the candidate and version are valid, the broker then attempts to find a binary record matching the requested platform:
  - If an **exact platform** match exists in the metadata (e.g. a binary specifically for `linuxx64`), that binary is selected.
  - If no exact match is found for the platform:
    - The broker checks if a platform labeled **`UNIVERSAL`** exists for this candidate version. A “UNIVERSAL” binary indicates the artifact is OS-agnostic (common for purely Java archives or scripts). If a universal binary exists, it will be used as a **fallback** for any platform. This applies both to known platforms and to the `exotic` platform:
      - For a known platform request (e.g. `linuxx64`) with only a universal binary available, the universal binary is chosen ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=Given%20a%20valid%20UNIVERSAL%20binary,2.4.7.zip)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=Then%20a%20redirect%20to%20%22http%3A%2F%2Fdl.bintray.com%2Fgroovy%2Fmaven%2Fapache,2.4.7.zip%22%20is%20returned)).
      - For an `exotic` platform request, if a universal binary is available, it is also chosen ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)).
    - If neither an exact platform match nor a universal binary is found, the broker returns **HTTP 404 Not Found**. For example, if a user requests a platform that is recognized but the candidate doesn’t support it (and no universal fallback), the response is 404 (no binary for that OS/arch) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=When%20a%20download%20request%20is,download%2Fjava%2F8u101%2Fexotic)). No audit is logged in this case ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)).
  - **Special case – `exotic`:** The `exotic` platform code represents an unknown/unsupported OS or architecture as detected by the install script. The broker treats `exotic` as a valid platform token that triggers the above fallback logic. If a universal binary exists, the service will use it; otherwise, it responds 404 (meaning the candidate cannot be installed on that exotic platform) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=When%20a%20download%20request%20is,download%2Fgroovy%2F2.4.7%2Fexotic)). (By contrast, an entirely unrecognized platform string triggers a 400 as noted above.)

- **Redirect URL Computation:** Once a matching binary record is found (exact or via fallback), the broker determines the download URL to redirect the client:
  - For **third-party candidates** (regular SDKs), the exact download URL is stored in the database record and is used as-is for the redirect. For example, a Groovy 2.4.7 universal binary might have a stored URL `http://dl.bintray.com/groovy/maven/apache-groovy-binary-2.4.7.zip`, which the broker will use for all platform requests ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=Given%20a%20valid%20UNIVERSAL%20binary,2.4.7.zip)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=Then%20a%20redirect%20to%20%22http%3A%2F%2Fdl.bintray.com%2Fgroovy%2Fmaven%2Fapache,2.4.7.zip%22%20is%20returned)).
  - For **SDKMAN CLI (script)** – treated as candidate `"sdkman"` – and **Native SDKMAN CLI** – treated as candidate `"native"` – the URLs are not statically stored for every version but are derived from known distribution locations:
    - **SDKMAN Bash CLI**: If the request is for the SDKMAN shell-based CLI distribution (identified by `candidate = "sdkman"`), the broker computes the redirect URL pointing to the SDKMAN CLI’s GitHub release asset. Specifically, for a stable CLI version (e.g. `5.5.5`), it redirects to the GitHub Releases download for that version, using the artifact naming convention `sdkman-cli-{version}.zip`. For example: **Location:** `https://github.com/sdkman/sdkman-cli/releases/download/{version}/sdkman-cli-{version}.zip`. For a CLI **beta version** denoted by a special string (e.g. `latest+abcdef`), the broker uses the `latest` release tag on GitHub, e.g. **Location:** `https://github.com/sdkman/sdkman-cli/releases/download/latest/sdkman-cli-{version}.zip` (where `{version}` is the full `latest+abcdef` string) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=Then%20a%20redirect%20to%20%22https%3A%2F%2Fgithub.com%2Fsdkman%2Fsdkman,latest%2Babcdef.zip%22%20is%20returned)). These URLs point to the ZIP archive of the CLI script distribution.
    - **SDKMAN Native CLI**: If `candidate = "native"`, the broker builds the redirect URL to the native CLI binary hosted on GitHub. The native CLI artifacts are hosted under the **sdkman-cli-native** project’s releases. The broker uses the requested native CLI `version` together with the `platform` to construct the filename. It translates the SDKMAN platform code to the appropriate platform-specific artifact name used in the release. For example, a native CLI version `0.1.0` for `windowsx64` is served from an asset like `cli-native-0.1.0-x86_64-pc-windows-msvc.zip` (as found in the release assets). Similarly, a Linux x64 request might result in an asset name `cli-native-{version}-x86_64-unknown-linux-gnu.zip`, and MacOS ARM64 in `cli-native-{version}-aarch64-apple-darwin.zip`. The base URL used is the sdkman-cli-native GitHub releases (e.g. `https://github.com/sdkman/sdkman-cli-native/releases/download/{version}/...`). **Note:** The broker contains an internal mapping from the incoming `platform` token to the native binary’s naming convention. If the combination of version and platform does not correspond to a published asset (e.g. that platform isn’t supported for that version), the broker will return 404 as per the general logic above.
  - For any chosen binary, the broker responds with an **HTTP 302 Found** redirect. The `Location` header is set to the computed URL of the binary.

- **Response Headers:** In addition to the standard `Location` header for redirects, the broker includes additional headers to convey metadata about the binary:
  - **Checksum Headers:** If the persistence layer has checksum values stored for the binary (e.g. SHA-1, SHA-256), the service adds them to the response as `X-Sdkman-Checksum-SHA-1`, `X-Sdkman-Checksum-SHA-256`, etc. The header value is the checksum hash string. For example, for a Groovy 2.4.7 binary with a known SHA-1, the response includes `X-Sdkman-Checksum-SHA-1: 6f1b9599f99393724ea134951aa605037178b63a` ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)), and similarly for SHA-256 `X-Sdkman-Checksum-SHA-256` ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=And%20a%20checksum%20,1%22%20is%20returned)). These allow the SDKMAN client to verify download integrity.
  - **Archive Type Header:** The broker also provides an indication of the archive type. This is written as a header (e.g. `X-Sdkman-Archive-Extension`) specifying the format of the archive in the URL. For instance, if the binary is a `zip` file, it will indicate “zip”; if it’s a `tar.gz`, it will indicate “tar.gz”. This was introduced to help the SDKMAN CLI decide how to extract the downloaded archive. *(This header was added in a previous version to handle non-zip archives; the CLI may use it to choose the correct extraction method. It is always provided alongside the redirect.)*

- **Audit Logging:** After successfully resolving a download request (just before issuing the redirect), the broker records an audit entry in the database. This entry logs:
  - The **candidate** and **version** that was downloaded.
  - The **platform** context:
    - If a platform-specific binary was served, that platform is recorded.
    - If a universal binary was served (fallback case), the audit still notes the binary as “UNIVERSAL” for the candidate/version and also notes the requesting platform. For example, an audit entry might read as *“groovy 2.4.7 UNIVERSAL”* recorded for *“LinuxX64”* ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)) – indicating a Groovy 2.4.7 universal artifact was delivered to a Linux x64 request. Likewise, if the request came from an exotic platform but used a universal binary, it might record *“UNIVERSAL ... for Exotic”* ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)).
    - If the candidate is SDKMAN’s own CLI, the audit will record `sdkman` or `native` as the candidate and the version string (e.g. `5.5.5` or `latest+abcdef` for the CLI script, `1.0.0` or similar for the native CLI) along with the platform (for native CLI, the specific OS; for the bash CLI, the platform is effectively universal, so it may be logged as “UNIVERSAL” or “UNIVERSAL for {Platform}” as appropriate).
  - Audit entries are **not** created for failed requests (400/404 responses). The test scenarios explicitly confirm that no audit record is written when a request is invalid or not found ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=%6050%60%60%60%60)) ([Handle exotic platform. · sdkman/sdkman-broker@468019d · GitHub](https://github.com/sdkman/sdkman-broker/commit/468019d60eed36647df3e43b4c411f0fc6fab04d#:~:text=)).

### GET `/download/sdkman/install/{version}/{platform}` & `/download/sdkman/selfupdate/{version}/{platform}`

*(These are specific forms of the above `/download` endpoint for SDKMAN’s CLI distribution. They follow the same core logic as a normal download but are documented separately for clarity.)*

- The `candidate` is `"sdkman"` (the CLI), and the path includes an additional segment indicating the context: either `install` or `selfupdate`. In the current implementation, both paths behave equivalently in terms of resolving the binary, with the difference being mainly in how they are invoked by the SDKMAN scripts:
  - **`install`** is used by the initial installation script (e.g. `get.sdkman.io`) when installing the CLI for the first time.
  - **`selfupdate`** is used by the CLI itself when performing a self-update (via `sdk selfupdate`). 

- **Behavior:** Both endpoints ultimately call the same internal logic as described for `/download/{candidate}/{version}/{platform}` with `candidate = sdkman`. The provided `version` should be the CLI version to download:
  - The service expects a valid CLI version number or version identifier. If the version is not the current stable or beta as stored, it still attempts to fetch that version’s artifact from GitHub (since older CLI releases remain available). If such a version is not found in the system (e.g. unknown), it will result in a 404 similar to other candidates.
  - The `platform` is typically the one detected by the install script or CLI (e.g. `linuxx64`, etc.). Note that the CLI Bash distribution is platform-independent (universal), so the service will actually return the same ZIP for any platform (the archive contains shell scripts and configuration). The broker may treat the CLI distribution as a `UNIVERSAL` platform internally. In practice, it will still record the audit with platform context as described (likely marking it universal).

- **Redirects & Audit:** The redirect URL is computed as described: pointing to the SDKMAN CLI zip on GitHub. An audit entry is recorded for the CLI download event (candidate `sdkman`). If the version corresponds to a beta identifier (e.g. `latest+abcdef`), the audit will reflect that string as the version. The `install` vs `selfupdate` distinction does not change how the audit is recorded (both will simply note the candidate/version/platform).

- There is no functional difference in validation or outcome between using `install` or `selfupdate` in the path – both are accepted. (In earlier versions, these were introduced to possibly allow the broker to apply different logic or restrictions, but currently they converge to the same behavior.)

### GET `/download/native/install/{version}/{platform}` & `/download/native/selfupdate/{version}/{platform}`

*(Specific endpoints for the native SDKMAN CLI binary; similar in role to the above, with `candidate = native`.)*

- **Behavior:** Follows the same pattern as `/download/{candidate}/{version}/{platform}`. The `install` or `selfupdate` segment is accepted but does not fundamentally alter logic. The broker uses the `version` and `platform` to find the appropriate native CLI binary as described earlier. 

- If the requested native CLI version is the current stable or beta known to the system, it will resolve to the GitHub release URL. If an arbitrary version is requested:
  - If it exists as a release on the sdkman-cli-native repository, the broker can serve it (assuming the naming convention and database mapping covers it).
  - If it’s not recognized or not found, a 404 is returned (just as with any candidate version missing).

- **Platform mapping:** The native CLI requires an exact platform match (no universal binary exists for native CLI since they are OS-specific). Thus, for native CLI, the `platform` must correspond to one of the supported ones (Linux, Mac, Windows variants). If an unsupported or unknown platform is requested for a native CLI version, the broker responds with 404 (even if the platform code might be known in general, because there is no “universal” fallback for native executables). For example, `linuxarm32hf` might not have a native binary – such a request yields 404 Not Found ([Test scenarios where platform or distribution is not supported. · sdkman/sdkman-broker@ac5e8fc · GitHub](https://github.com/sdkman/sdkman-broker/commit/ac5e8fc84c34c37774896f0912ae409e5ac157fc#:~:text=Scenario%3A%20Return%20a%20NOT_FOUND%20status,for%20an%20unknown%20platform)) ([Test scenarios where platform or distribution is not supported. · sdkman/sdkman-broker@ac5e8fc · GitHub](https://github.com/sdkman/sdkman-broker/commit/ac5e8fc84c34c37774896f0912ae409e5ac157fc#:~:text=When%20a%20download%20request%20is,download%2Fnative%2Finstall%2F0.1.0%2Flinuxarm32sf)).

- **Audit & Headers:** The audit entry for a native CLI download will record `native` as the candidate, the version (e.g. `0.1.0`), and the platform (e.g. `WindowsX64`, `LinuxX64`, etc.). Checksum headers are included if available (the native CLI releases typically provide checksums for each binary; these would be stored and returned if present). The archive type header will typically indicate `zip` for all native CLI archives (since they are released as zip files per platform).

### GET `/version/sdkman/{type}/{channel}`

Provides the current version identifier of the SDKMAN CLI, where `{type}` can be `bash` (the traditional shell-based CLI) or `native` (the new native CLI), and `{channel}` can be `stable` or `beta`. This endpoint allows clients to query what the latest available CLI versions are without downloading them.

- **Logic:** The broker reads the requested CLI version info from its persistence:
  - It keeps track of the “Stable CLI version” and “Beta CLI version” for both Bash and Native variants (these are updated via administrative processes or the vendor API when new versions are released). For example, it might store Stable Bash CLI version = `5.5.5`, Beta Bash CLI version = `latest+abcdef`, Stable Native CLI version = `1.0.0`, Beta Native CLI version = `0.0.15` (illustrative values) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)).
  - Based on the path, the broker selects the appropriate field. For instance:
    - `GET /version/sdkman/bash/stable` -> returns the current stable Bash CLI version (e.g. `"5.5.5"`) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=Given%20the%20Stable%20Bash%20CLI,5.5.5)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)).
    - `GET /version/sdkman/bash/beta` -> returns the current beta version string for the Bash CLI (e.g. `"latest+abcdef"`) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)).
    - `GET /version/sdkman/native/stable` -> returns the stable Native CLI version (e.g. `"1.0.0"`) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=Scenario%3A%20Read%20the%20current%20Stable,Native%20SDKMAN%20binary%20resource%20version)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=And%20the%20content%20type%20is,text%2Fplain)).
    - `GET /version/sdkman/native/beta` -> returns the beta Native CLI version (e.g. `"0.0.15"`) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=Scenario%3A%20Read%20the%20current%20Beta,Native%20SDKMAN%20binary%20resource%20version)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=And%20the%20content%20type%20is,text%2Fplain)).
  - The response is a simple **text/plain** body containing the version string ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=When%20a%20GET%20request%20is,version%2Fsdkman%2Fbash%2Fstable)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=And%20the%20content%20type%20is,text%2Fplain)).

- **Response:** On success, returns **HTTP 200 OK** with content type `text/plain`. The body is exactly the version string (no JSON or formatting, just the raw version). For example, a stable version query might return a body of `5.5.5` ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=Given%20the%20Stable%20Bash%20CLI,5.5.5)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=And%20the%20content%20type%20is,text%2Fplain)), while a beta might return `latest+abcdef` ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)). 

- **Behavior for Unknown Entries:** If for some reason the requested `{type}` or `{channel}` is not recognized (e.g. a typo in the URL), the broker will respond with 404 (since the route won’t match any known resource). However, under normal operation `{type}` must be one of `bash` or `native`, and `{channel}` one of `stable` or `beta` – no other values are allowed. Both values are part of the path and must be present.

- **No Side-Effects:** This endpoint is read-only. It does **not** create any audit log or modify any state. Its purpose is solely to inform the CLI installer/updater what version to fetch next.

### GET `/download/sdkman/version/{channel}`  (Legacy)

> **Note:** This is a **legacy endpoint** preserved for backward compatibility with older SDKMAN clients. It is slated for deprecation and removal in a future version.

This endpoint was the original way to query the current CLI version (prior to introduction of the `/version/sdkman/{type}/{channel}` endpoints). Here `{channel}` can be `stable` or `beta`, referring to the CLI release channel. It returns the latest version of the **Bash CLI** in that channel.

- **Behavior:** It returns a plain text version string, identical to calling `/version/sdkman/bash/{channel}`. For example, `GET /download/sdkman/version/stable` might return `5.5.5` ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=Scenario%3A%20Read%20the%20legacy%20current,Bash%20SDKMAN%20binary%20resource%20version)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)), and `.../beta` might return `latest+abcdef` ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=Given%20the%20Beta%20Bash%20CLI,latest%2Babcdef)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=And%20the%20content%20type%20is,text%2Fplain)). The service responds with 200 OK and `text/plain` content type.

- **Logic:** Internally, the broker fetches the “Beta CLI version” or “Stable CLI version” field (for the Bash CLI) from the database and returns it. (No platform or candidate lookup is involved here since it’s a global application setting.)

- **No Audit:** As with the new version endpoints, this call does not produce an audit record.

- **Clients:** Older versions of the SDKMAN installation scripts or CLI might hit this endpoint to decide whether an update is needed. Newer clients use the unified `/version/sdkman/...` endpoints with type qualifiers. A TODO in the codebase indicates these legacy endpoints will be retired once it’s confirmed they are no longer in use ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=)) ([Accommodate new binary version URL scheme. · sdkman/sdkman-broker@9d5f92b · GitHub](https://github.com/sdkman/sdkman-broker/commit/9d5f92b7f4e726a491c491b01a5b738deef0c497#:~:text=TODO%3A%20Retire%20these%20legacy%20endpoints%21%21%21)).

### Other Endpoints

- **Health Check:** The service likely exposes a simple health or ping endpoint (e.g. GET `/health` or similar) for container orchestration to verify the app status. This returns a 200 OK if the service is up (and possibly checks DB connectivity). *(This endpoint was not explicitly described in prior versions, but it’s common in microservices. If present, it has no business logic beyond reporting health.)*

- **Vendor API Endpoints:** (Not part of the broker’s download endpoints) – The broker does not directly handle candidate publication or validation; those are handled by other services (e.g. the “candidates” service with `/candidates/validate` and hooks endpoints). The broker’s scope is limited to download resolution, so it has no public endpoints for modifying data. All data (candidate binaries, CLI versions, checksums, etc.) are managed via internal APIs or the persistence layer separately.

## Internal Logic and Data Models

### Candidate and Version Records

The broker’s database contains records for each candidate version and its available binaries:
- A **Candidate** (e.g. "java", "groovy", "sdkman") has one or more **Version** entries.
- Each **Version** entry may have one or multiple **Platform-specific binary** records. For example, a Java version might have `LINUX_64`, `MAC_OSX`, `WINDOWS_64` entries (with their respective download URLs), and possibly a `UNIVERSAL` entry if applicable. In the database, platforms might be stored as uppercase identifiers (e.g. `LINUX_64`, `UNIVERSAL`, etc.), which correspond to the lowercase tokens used in the URL (`linuxx64`, etc.).
- Each binary record can include **Checksum** fields (SHA1, SHA256, etc.) and an **Archive Type** field (e.g. `ZIP` or `TAR.GZ`). These are used to populate the response headers as described.
- If a version is marked as **Visible/Valid**, it means it’s available for download. (Invalid or soft-deleted versions won’t be found and result in 404 on requests.)

When resolving a download, the broker queries this data:
1. Find the candidate → then the version → then the binary by platform (or universal fallback).

### Current CLI Version Tracking

The broker maintains special fields for the SDKMAN CLI’s latest versions:
- **Stable Bash CLI Version** (e.g. `SDKMAN_VERSION` like "5.5.5").
- **Beta Bash CLI Version** (e.g. a string "latest+abcdef" representing a bleeding-edge build).
- **Stable Native CLI Version** (e.g. `SDKMAN_NATIVE_VERSION` like "1.0.0").
- **Beta Native CLI Version** (e.g. "0.0.15" if one is being tested).

These are stored in the database (for example, in a collection that might have a single document with these fields, or in key-value form). They are updated out-of-band whenever a new CLI release is promoted to stable or beta. The `/version/...` endpoints simply read these values. The `/download/sdkman...` and `/download/native...` endpoints indirectly use these when the install scripts call with the values (the install script itself retrieves them first to know what version to request).

### Audit Log

Download events are saved to an **Audit** collection. Each record typically includes:
- **Candidate** name.
- **Version**.
- **Platform** (the binary type that was served, e.g. `LINUX_64`, `MAC_OSX`, or `UNIVERSAL`).
- **Requester Platform** or context (e.g. the user’s platform if different from the binary’s platform; this may be logged in a combined form as seen in the scenarios, “for {Platform}”). In practice, the audit entry likely stores both the artifact’s platform and the requesting platform if they differ (for universal fallbacks or exotic).
- **Timestamp** of the request.
- Possibly other info such as IP or request headers if configured, though the specs only highlight candidate/version/platform details.

The audit insertion occurs only on successful resolution (just before the 302 redirect is sent). Failures (400/404) do not trigger any audit entry, ensuring that only actual downloads are logged.

Each audit log entry for a CLI download (`sdkman` or `native`) will similarly note the event (this helps in tracking how often the CLI itself is installed or updated on various platforms). For example, an audit entry might record *“sdkman 5.5.5 UNIVERSAL for DarwinX64”* when a Mac user installs the stable shell CLI, whereas *“native 1.0.0 WINDOWS_64”* might be recorded for a Windows user downloading the native CLI (since that binary is Windows-specific).

---

**Note:** The above specification consolidates behavior from versions v1 through v4 of the service. All logic from earlier versions (such as platform fallback rules, beta channel handling, exotic platform recognition, and header additions for checksums and archive type) have been integrated. This reflects the current, complete behavior of the SDKMAN Broker service and can be used as the authoritative reference for reimplementation or debugging.