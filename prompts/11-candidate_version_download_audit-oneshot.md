# Candidate Version Download Audit

Implement comprehensive audit logging for the candidate version download endpoint (`GET /download/{candidate}/{version}/{platform}`)
to track every download request. This feature ensures compliance with the legacy broker service specification and
provides visibility into download usage patterns.

## Requirements

- Create audit entries for all successful candidate version downloads (HTTP 302 redirects only)
- Extract client IP address from `X-Real-IP` header for audit records
- Extract User-Agent from request headers for audit records
- Store platform and distribution information as specified in the legacy broker service
- Use the existing `AuditRepository` infrastructure for persistence
- Handle audit failures gracefully without impacting download performance
- Maintain feature parity with the legacy application's audit implementation
- Support nullable vendor information in audit records
- Generate audit timestamps at the time of successful download resolution

## Rules

- rules/ddd-rules.md
- rules/hexagonal-architecture-rules.md
- rules/kotest-rules.md
- rules/kotlin-rules.md

## Domain

```kotlin
// Audit domain model (already exists)
data class Audit(
    val id: Option<UUID>,                // Can be auto-generated by database if not provided
    val command: String,                 // Always "install" for candidate downloads
    val candidate: String,               // Candidate name (e.g., "java", "kotlin")
    val version: String,                 // Version downloaded (e.g., "17.0.2")
    val platform: String,                // Normalized platform identifier (e.g., "LinuxX64")
    val dist: String,                    // Distribution served to user (e.g., "MAC_ARM64", "UNIVERSAL")
    val vendor: Option<String>,          // Optional vendor for multi-vendor candidates like java (e.g., "tem", "openjdk")
    val host: Option<String>,            // Optional Client IP from `X-Real-IP` header
    val agent: Option<String>,           // Optional `User-Agent` header value
    val timestamp: Instant               // Time of successful download resolution
)
```

## Extra Considerations

- Audit entries should only be created for successful downloads (HTTP 302 status)
- Failed requests (400/404) should not generate audit entries
- Audit logging must be asynchronous to avoid impacting download performance
- Missing request headers (X-Real-IP, User-Agent) should be persisted as `null` in the db audit record
- The vendor field should be populated from the resolved version record if present
- The platform field should use the normalized platform identifier, not the raw URL parameter
- The dist field should indicate the actual distribution served (platform-specific or UNIVERSAL)
- Database failures in audit logging should be logged but not propagate to the client

## Testing Considerations

- Unit tests for audit context extraction from HTTP requests
- Integration tests verifying audit entries are created for successful downloads
- Test scenarios for missing or invalid request headers
- Verify audit entries are not created for failed requests (400/404)
- Test audit repository integration with the download service
- Performance tests to ensure audit logging doesn't impact download response times
- Test proper handling of nullable vendor information

## Implementation Notes

- Wire the `PostgresAuditRepository` into the application's dependency injection in `App.kt`
- Modify the download routes to extract audit context from HTTP requests
- Update the `VersionService` to accept audit context and create audit entries
- Use Arrow's functional error handling patterns for audit operations
- Ensure audit logging follows the existing transactional patterns
- Maintain backwards compatibility with existing download endpoint behavior
- Follow the existing architectural patterns for primary and secondary adapters

## Specification by Example

### Successful Download with Audit
```http
GET /download/java/17.0.2-tem/linuxx64
X-Real-IP: 203.0.113.195
User-Agent: curl/7.68.0

HTTP/1.1 302 Found
Location: https://github.com/adoptium/temurin17-binaries/releases/download/...
X-Sdkman-Checksum-SHA-256: e3b0c44298fc...
X-Sdkman-ArchiveType: tar.gz
```

**Audit Entry Created:**

```sql
INSERT INTO audit (id, command, candidate, version, platform, dist, vendor, host, agent, timestamp)
VALUES (
    '123e4567-e89b-12d3-a456-426614174000',
    'install',
    'java',
    '17.0.2-tem',
    'LinuxX64',
    'LINUX_64',
    'tem',
    '203.0.113.195',
    'curl/7.68.0',
    '2023-10-15T10:30:00Z'
);
```

### UNIVERSAL Fallback Download
```http
GET /download/groovy/4.0.0/linuxx64
X-Real-IP: 192.168.1.100
User-Agent: SDKMAN/5.19.0

HTTP/1.1 302 Found
Location: https://groovy.jfrog.io/artifactory/dist-release-local/...
X-Sdkman-ArchiveType: zip
```

**Audit Entry Created:**

```sql
INSERT INTO audit (id, command, candidate, version, platform, dist, vendor, host, agent, timestamp)
VALUES (
    '456e7890-e89b-12d3-a456-426614174001',
    'install',
    'groovy',
    '4.0.0',
    'LinuxX64',
    'UNIVERSAL',
    NULL,
    '192.168.1.100',
    'SDKMAN/5.19.0',
    '2023-10-15T10:30:00Z'
);
```


### Failed Download (No Audit Entry)
```http
GET /download/java/99.0.0/linuxx64
X-Real-IP: 203.0.113.195
User-Agent: curl/7.68.0

HTTP/1.1 404 Not Found
```

**No audit entry created for failed requests.**

## Verification

- [ ] AuditRepository is properly wired into the application dependency injection
- [ ] Download endpoint extracts client IP from X-Real-IP header
- [ ] Download endpoint extracts User-Agent from request headers
- [ ] Audit entries are created only for successful downloads (302 responses)
- [ ] Audit entries contain all required fields with correct values
- [ ] Vendor information is properly stored when available
- [ ] Platform identifiers are normalized correctly in audit entries
- [ ] Distribution type (dist) reflects the actual binary served
- [ ] Audit logging is asynchronous and doesn't impact download performance
- [ ] Missing request headers are handled gracefully with fallback values
- [ ] Audit failures are logged but don't propagate errors to clients
- [ ] Integration tests verify audit entries are persisted correctly
- [ ] Unit tests cover audit context extraction and error scenarios
- [ ] Existing download endpoint behavior remains unchanged
- [ ] Code is well formatted using `./gradlew ktlintFormat`
- [ ] Build passes with all tests and checks: `./gradlew check`
- [ ] Static analysis passes with `./gradlew detekt`
